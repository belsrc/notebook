---
tags:
  - rust
  - notes
---
## Rust Compiler

`rustc` is the provided compiler for the Rust language. It is the program that will convert your `.rs` files into executables. It also containers the linter used for Rust files. When `rustc` compiles your code, it will also run the lints.

---
### Basic Use

Given the simple Rust file:

```rust
fn main() {
  println!("Hello, world!");
}
```

In order to compile and run this file, you would use:

```
rustc hello.rs
```

> [!note]
> You only ever pass `rustc` the _crate root_, not every file we wish to compile.

---
### Command Line Flags

 `-h`/`--help`
    This flag will print out help information for `rustc`.

`--cfg`
    This flag can turn on or off various `#[cfg]` settings for conditional compilation. 

`--crate-type`
    This instructs `rustc` on which crate type to build. This flag accepts a comma-separated list of values, and may be specified multiple times. The valid crate types are:

- `lib` — Generates a library kind preferred by the compiler, currently defaults to `rlib`.
- `rlib` — A Rust static library.
- `staticlib` — A native static library.
- `dylib` — A Rust dynamic library.
- `cdylib` — A native dynamic library.
- `bin` — A runnable executable program.
- `proc-macro` — Generates a format suitable for a procedural macro library that may be loaded by the compiler.

`--crate-name`
    This informs `rustc` of the name of your crate.

`--edition`
    This flag takes a value of `2015`, `2018` or `2021`. The default is `2015`.

- Rust `2015` has a theme of _"stability"_. It commenced with the release of 1.0, and is the "default edition".
- Rust `2018`, the edition system was created for this release. This coincided with a number of other features all coordinated around the theme of _"productivity"_.
- Rust `2021` Edition contains several changes that bring new capabilities and more consistency to the language, and opens up room for expansion in the future.

`--emit`
    This flag controls the types of output files generated by the compiler. It accepts a comma-separated list of values, and may be specified multiple times. The valid emit kinds are:

- `asm` — Generates a file with the crate's assembly code. The default output filename is `CRATE_NAME.s`.
- `dep-info` — Generates a file with Makefile syntax that indicates all the source files that were loaded to generate the crate. The default output filename is `CRATE_NAME.d`.
- `link` — Generates the crates specified by `--crate-type`. The default output filenames depend on the crate type and platform. This is the default if `--emit` is not specified.
- `llvm-bc` — Generates a binary file containing the LLVM bitcode. The default output filename is `CRATE_NAME.bc`.
- `llvm-ir` — Generates a file containing LLVM IR. The default output filename is `CRATE_NAME.ll`.
- `metadata` — Generates a file containing metadata about the crate. The default output filename is `libCRATE_NAME.rmeta`.
- `mir` — Generates a file containing rustc's mid-level intermediate representation. The default output filename is `CRATE_NAME.mir`.
- `obj` — Generates a native object file. The default output filename is `CRATE_NAME.o`.

`--print`
    This flag prints out various information about the compiler. This flag may be specified multiple times, and the information is printed in the order the flags are specified. Specifying a `--print` flag will usually disable the `--emit` step and will only print the requested information.

- `crate-name` — The name of the crate.
- `file-names` — The names of the files created by the `link` emit kind.
- `sysroot` — Path to the sysroot.
- `target-libdir` - Path to the target libdir.
- `cfg` — List of cfg values. See conditional compilation for more information about cfg values.
- _Check docs for full list_

`-g`
    A synonym for `-C debuginfo=2`.

`-O`
    A synonym for `-C opt-level=2`.

`-o`
    This flag controls the output filename.

`--out-dir`
    The outputted crate will be written to this directory. This flag is ignored if the `-o` flag is used.

`--explain`
    Each error of `rustc`'s comes with an error code; this will print out a longer explanation of a given error.

`--test`
    When compiling this crate, `rustc` will ignore your `main` function and instead produce a test harness.

`--target`
    This controls which target to produce.

`-v`/`--verbose`
    This flag, when combined with other flags, makes them produce extra output.


> [!note]
> For a full list check the [documentation](https://doc.rust-lang.org/rustc/command-line-arguments.html).

---

## `rustup` CLI

`rustup` is a _toolchain multiplexer_. It installs and manages many Rust toolchains and presents them all through a single set of tools. Rust is distributed on three different release channels: `stable`, `beta`, and `nightly`. `rustup` uses the stable channel by default, which represents the latest release of Rust.

When a new version of Rust is released, enter:

```
rustup update
```

This will update the various toolchains as well as self-update.

```
info: syncing channel updates for 'stable'
info: downloading component 'rustc'
info: downloading component 'rust-std'
info: downloading component 'rust-docs'
info: downloading component 'cargo'
info: installing component 'rustc'
info: installing component 'rust-std'
info: installing component 'rust-docs'
info: installing component 'cargo'
info: checking for self-update
info: downloading self-update
```

---

## Cargo

Cargo is the Rust _package manager_. Cargo downloads your Rust package’s dependencies, compiles your packages, makes distributable packages, and uploads them to [crates.io](https://crates.io/), the Rust community’s _package registry_.

---
### New Cargo Project.

To create a new Rust project using Cargo simply run the command:

```
cargo new <proj name>
```

This will create a new directory with the given name. Inside that directory will be a few files/folders. 
- `Cargo.toml` - Cargo's manifest file.
- `src` directory containing a `main.rs` file.

It will also initialize a new Git repository in the directory. As well as a `.gitignore`. The Git will be skipped if the directory that you are starting the project in in is an existing Git repository already.

---
### Manifest `toml`

Inside the manifest file there are a few sections. Denoted by `[<name>]`.  These describe various aspects of the Rust project and how certain things should be carried out.

`[package]` - Contains various information such as the name of the package (`name`),  the version of the package (`version`) and the Rust edition to use (`edition`).

`[dependencies]` - The list of the dependencies the Rust package requires.

> [!note]
> For the entire list, visit the [documentation](https://doc.rust-lang.org/cargo/reference/manifest.html).

---
### Folder Structure

Cargo uses conventions for file placement to make it easy to dive into a new Cargo package:

```
.
├── Cargo.lock
├── Cargo.toml
├── src/
│   ├── lib.rs
│   ├── main.rs
│   └── bin/
│       ├── named-executable.rs
│       ├── another-executable.rs
│       └── multi-file-executable/
│           ├── main.rs
│           └── some_module.rs
├── benches/
│   ├── large-input.rs
│   └── multi-file-bench/
│       ├── main.rs
│       └── bench_module.rs
├── examples/
│   ├── simple.rs
│   └── multi-file-example/
│       ├── main.rs
│       └── ex_module.rs
└── tests/
     ├── some-integration-tests.rs
     └── multi-file-test/
         ├── main.rs
         └── test_module.rs
```

- `Cargo.toml` and `Cargo.lock` are stored in the root of your package (_package root_).
- Source code goes in the `src` directory.
- The default library file is `src/lib.rs`.
- The default executable file is `src/main.rs`.
    - Other executables can be placed in `src/bin/`.
- Benchmarks go in the `benches` directory.
- Examples go in the `examples` directory.
- Integration tests go in the `tests` directory.

---
### Cargo `build`, `run` and `check`

The `cargo build` command will compile and executable for your source files. This usually placed in the `target/debug` directory. Which then can be ran like any other executable in the terminal.

As this is a common pattern, and tedious to do every time we want to check the application, another command is provided. `cargo run` , like `build`, will build the executable. But will also run it when the build is finished.

Since Rust is a compiled language, sometimes we just want to make sure that it _can_ compile without actually producing the binary file. In order to facilitate that, there is the `cargo check` command. This is also much faster as it skips the aforementioned build step.

---
### Release Build

When you are ready, you can have Rust compile a release quality build using the `--release` flag.

```
cargo build --release
```

This compiles the executable with optimizations. This will make the application itself run faster but causes the build step to take longer than the "debug" version.

---
### Common Cargo commands.

`cargo bench`
    Execute benchmarks of a package.

`cargo build`
    Compile a package.

  `cargo check`
    Check a local package and all of its dependencies for errors.

`cargo clean`
    Remove artifacts that Cargo has generated in the past.

`cargo doc`
    Build a package’s documentation.

`cargo fetch`
    Fetch dependencies of a package from the network.

`cargo fix`
    Automatically fix lint warnings reported by rustc.

`cargo run`
    Run a binary or example of the local package.

`cargo rustc`
    Compile a package, and pass extra options to the compiler.

`cargo test`
    Execute unit and integration tests of a package.

`cargo generate-lockfile`
    Generate `Cargo.lock` for a project.

`cargo tree`
    Display a tree visualization of a dependency graph.

`cargo update`
    Update dependencies as recorded in the local lock file.

`cargo verify-project`
    Check correctness of crate manifest.

`cargo init`
    Create a new Cargo package in an existing directory.
 
`cargo install`
    Build and install a Rust binary.

`cargo new`
    Create a new Cargo package.

`cargo search`
    Search packages in crates.io.

`cargo uninstall`
    Remove a Rust binary.

`cargo package`
    Assemble the local package into a distributable tarball.

`cargo publish`
    Upload a package to the registry.

`cargo help`
    Display help information about Cargo.

`cargo version`
    Show version information.

> [!note]
> For a full list with detailed descriptions and options, check the [documentation](https://doc.rust-lang.org/cargo/commands/cargo.html).

---

### References

[The Rust Edition Guide](https://doc.rust-lang.org/edition-guide/introduction.html)
[The `rustc` book](https://doc.rust-lang.org/rustc/what-is-rustc.html)
[The `rustup` book](https://rust-lang.github.io/rustup/index.html)
[The Cargo book](https://doc.rust-lang.org/cargo/)
